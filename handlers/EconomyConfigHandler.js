/**
 * Handler d√©di√© √† la configuration de l'√©conomie
 */

const { EmbedBuilder, ActionRowBuilder, StringSelectMenuBuilder } = require('discord.js');

class EconomyConfigHandler {
    constructor(dataManager) {
        this.dataManager = dataManager;
    }

    /**
     * Afficher le menu principal de configuration √©conomique
     */
    async showMainConfigMenu(interaction) {
        const embed = new EmbedBuilder()
            .setColor('#f39c12')
            .setTitle('üí∞ Configuration √âconomique')
            .setDescription('S√©lectionnez une section √† configurer :')
            .addFields([
                { name: '‚ö° Actions', value: 'Configurer travailler, voler, crime, etc.', inline: true },
                { name: 'üè™ Boutique', value: 'G√©rer les articles et prix', inline: true },
                { name: '‚öñÔ∏è Karma', value: 'Syst√®me de r√©compenses karma', inline: true },
                { name: 'üìÖ Daily', value: 'R√©compenses quotidiennes', inline: true },
                { name: 'üí¨ Messages', value: 'R√©compenses par message', inline: true },
                { name: 'üìä Statistiques', value: 'Affichage et reset des donn√©es', inline: true }
            ]);

        const selectMenu = new StringSelectMenuBuilder()
            .setCustomId('economy_config_main')
            .setPlaceholder('Choisissez une section...')
            .addOptions([
                {
                    label: '‚ö° Configuration Actions',
                    value: 'actions',
                    description: 'Travailler, voler, crime, p√™cher, etc.'
                },
                {
                    label: 'üè™ Configuration Boutique',
                    value: 'shop',
                    description: 'Articles, prix, r√¥les temporaires'
                },
                {
                    label: '‚öñÔ∏è Configuration Karma',
                    value: 'karma',
                    description: 'Niveaux et r√©compenses karma'
                },
                {
                    label: 'üìÖ Configuration Daily',
                    value: 'daily',
                    description: 'R√©compenses quotidiennes et streaks'
                },
                {
                    label: 'üí¨ Configuration Messages',
                    value: 'messages',
                    description: 'R√©compenses par message √©crit'
                },
                {
                    label: 'üìä Statistiques Syst√®me',
                    value: 'stats',
                    description: 'Donn√©es et reset du syst√®me'
                }
            ]);

        const row = new ActionRowBuilder()
            .addComponents(selectMenu);

        await interaction.reply({ embeds: [embed], components: [row], flags: 64 });
    }

    /**
     * G√©rer les interactions du menu principal
     */
    async handleMainMenu(interaction) {
        const value = interaction.values[0];

        switch (value) {
            case 'actions':
                await this.showActionsConfig(interaction);
                break;
            case 'shop':
                await this.showShopConfig(interaction);
                break;
            case 'karma':
                await this.showKarmaConfig(interaction);
                break;
            case 'daily':
                await this.showDailyConfig(interaction);
                break;
            case 'messages':
                await this.showMessagesConfig(interaction);
                break;
            case 'stats':
                await this.showStatsConfig(interaction);
                break;
            default:
                await interaction.reply({ content: '‚ùå Section non reconnue', flags: 64 });
        }
    }

    /**
     * Gestion des s√©lections d'actions
     */
    async handleActionSelection(interaction) {
        const action = interaction.values[0];
        // Ici la logique pour chaque action sera impl√©ment√©e
        await interaction.reply({ content: `Action s√©lectionn√©e: ${action} - √Ä impl√©menter`, flags: 64 });
    }

    /**
     * Gestion des options karma sp√©cifiques
     */
    async handleKarmaOption(interaction) {
        const option = interaction.values[0];
        // Ici la logique pour chaque option sera impl√©ment√©e
        await interaction.reply({ content: `Option karma: ${option} - √Ä impl√©menter`, flags: 64 });
    }

    /**
     * Gestion des options boutique sp√©cifiques
     */
    async handleShopOption(interaction) {
        const option = interaction.values[0];
        // Ici la logique pour chaque option sera impl√©ment√©e
        await interaction.reply({ content: `Option boutique: ${option} - √Ä impl√©menter`, flags: 64 });
    }

    /**
     * Gestion des options daily sp√©cifiques
     */
    async handleDailyOption(interaction) {
        const option = interaction.values[0];
        // Ici la logique pour chaque option sera impl√©ment√©e
        await interaction.reply({ content: `Option daily: ${option} - √Ä impl√©menter`, flags: 64 });
    }

    /**
     * Gestion des options messages sp√©cifiques
     */
    async handleMessagesOption(interaction) {
        const option = interaction.values[0];
        // Ici la logique pour chaque option sera impl√©ment√©e
        await interaction.reply({ content: `Option messages: ${option} - √Ä impl√©menter`, flags: 64 });
    }

    /**
     * Gestion des options stats sp√©cifiques
     */
    async handleStatsOption(interaction) {
        const option = interaction.values[0];
        // Ici la logique pour chaque option sera impl√©ment√©e
        await interaction.reply({ content: `Option stats: ${option} - √Ä impl√©menter`, flags: 64 });
    }

    /**
     * Configuration des actions √©conomiques
     */
    async showActionsConfig(interaction) {
        const embed = new EmbedBuilder()
            .setColor('#3498db')
            .setTitle('‚ö° Configuration des Actions')
            .setDescription('Configurez les diff√©rentes actions √©conomiques :')
            .addFields([
                { name: 'üí™ Travailler', value: 'Action positive üòá', inline: true },
                { name: 'üé£ P√™cher', value: 'Action positive üòá', inline: true },
                { name: 'üíù Donner', value: 'Action tr√®s positive üòá', inline: true },
                { name: 'üî™ Voler', value: 'Action n√©gative üòà', inline: true },
                { name: 'ü¶π Crime', value: 'Action tr√®s n√©gative üòà', inline: true },
                { name: 'üé≤ Parier', value: 'Action risqu√©e üòà', inline: true }
            ]);

        const row = new ActionRowBuilder()
            .addComponents([
                {
                    type: 3,
                    customId: 'economy_action_select',
                    placeholder: 'Choisissez une action √† configurer...',
                    options: [
                        { label: 'üí™ Travailler', value: 'travailler', description: 'Configurer les r√©compenses du travail' },
                        { label: 'üé£ P√™cher', value: 'pecher', description: 'Configurer les gains de la p√™che' },
                        { label: 'üíù Donner', value: 'donner', description: 'Configurer les donations' },
                        { label: 'üî™ Voler', value: 'voler', description: 'Configurer le syst√®me de vol' },
                        { label: 'ü¶π Crime', value: 'crime', description: 'Configurer les crimes' },
                        { label: 'üé≤ Parier', value: 'parier', description: 'Configurer les paris' }
                    ]
                }
            ]);

        await interaction.update({ embeds: [embed], components: [row] });
    }

    /**
     * Configuration de la boutique
     */
    async showShopConfig(interaction) {
        const guildId = interaction.guild.id;
        const shop = await this.dataManager.loadData('shop.json', {});
        const guildShop = shop[guildId] || [];

        const embed = new EmbedBuilder()
            .setColor('#e67e22')
            .setTitle('üè™ Configuration Boutique')
            .setDescription(`Articles configur√©s : **${guildShop.length}**`)
            .addFields([
                {
                    name: 'üìã Articles Disponibles',
                    value: guildShop.length > 0 
                        ? guildShop.slice(0, 10).map((item, i) => 
                            `${i + 1}. ${item.name} - ${item.price}‚Ç¨`
                        ).join('\n') + (guildShop.length > 10 ? `\n... et ${guildShop.length - 10} autres` : '')
                        : 'Aucun article configur√©',
                    inline: false
                }
            ]);

        const row = new ActionRowBuilder()
            .addComponents([
                {
                    type: 3,
                    customId: 'economy_shop_options',
                    placeholder: 'Choisissez une option...',
                    options: [
                        {
                            label: '‚ûï Ajouter Objet Personnalis√©',
                            value: 'add_custom',
                            description: 'Cr√©er un objet avec nom et description'
                        },
                        {
                            label: '‚è∞ Ajouter R√¥le Temporaire',
                            value: 'add_temp_role',
                            description: 'R√¥le avec dur√©e limit√©e'
                        },
                        {
                            label: '‚≠ê Ajouter R√¥le Permanent',
                            value: 'add_perm_role',
                            description: 'R√¥le √† vie'
                        },
                        {
                            label: '‚úèÔ∏è Modifier Articles',
                            value: 'edit_items',
                            description: 'Modifier articles existants'
                        },
                        {
                            label: 'üóëÔ∏è Supprimer Articles',
                            value: 'delete_items',
                            description: 'Supprimer des articles'
                        }
                    ]
                }
            ]);

        await interaction.update({ embeds: [embed], components: [row] });
    }

    /**
     * Configuration du karma
     */
    async showKarmaConfig(interaction) {
        const embed = new EmbedBuilder()
            .setColor('#9b59b6')
            .setTitle('‚öñÔ∏è Configuration Karma')
            .setDescription('Syst√®me de karma avec r√©compenses/sanctions automatiques')
            .addFields([
                { name: 'üéØ Niveaux Karma', value: 'Cr√©er des niveaux personnalis√©s', inline: true },
                { name: 'üèÜ R√©compenses Auto', value: 'Distribution automatique', inline: true },
                { name: 'üîÑ Reset Syst√®me', value: 'Remise √† z√©ro du karma', inline: true }
            ]);

        const row = new ActionRowBuilder()
            .addComponents([
                {
                    type: 3,
                    customId: 'economy_karma_options',
                    placeholder: 'Choisissez une option...',
                    options: [
                        {
                            label: 'üéØ G√©rer Niveaux Karma',
                            value: 'karma_levels',
                            description: 'Cr√©er/modifier niveaux personnalis√©s'
                        },
                        {
                            label: 'üèÜ R√©compenses Automatiques',
                            value: 'karma_rewards',
                            description: 'Configuration distribution auto'
                        },
                        {
                            label: 'üîÑ Reset Karma',
                            value: 'karma_reset',
                            description: 'Remettre √† z√©ro le syst√®me'
                        },
                        {
                            label: 'üìä Statistiques Karma',
                            value: 'karma_stats',
                            description: 'Voir les donn√©es actuelles'
                        }
                    ]
                }
            ]);

        await interaction.update({ embeds: [embed], components: [row] });
    }

    /**
     * Configuration du syst√®me daily
     */
    async showDailyConfig(interaction) {
        const dailyConfig = await this.dataManager.loadData('daily_config.json', {
            baseAmount: 100,
            streakBonus: 50,
            maxStreak: 30
        });

        const embed = new EmbedBuilder()
            .setColor('#2ecc71')
            .setTitle('üìÖ Configuration Daily')
            .setDescription('Configuration des r√©compenses quotidiennes')
            .addFields([
                { name: 'üí∞ Montant de base', value: `${dailyConfig.baseAmount}‚Ç¨`, inline: true },
                { name: 'üî• Bonus streak', value: `${dailyConfig.streakBonus}‚Ç¨ par jour`, inline: true },
                { name: 'üèÜ Streak maximum', value: `${dailyConfig.maxStreak} jours`, inline: true }
            ]);

        const row = new ActionRowBuilder()
            .addComponents([
                {
                    type: 3,
                    customId: 'economy_daily_options',
                    placeholder: 'Choisissez une option...',
                    options: [
                        {
                            label: 'üí∞ Montant de Base',
                            value: 'daily_amount',
                            description: 'Modifier la r√©compense de base'
                        },
                        {
                            label: 'üî• Bonus Streak',
                            value: 'streak_bonus',
                            description: 'Bonus par jour de streak'
                        },
                        {
                            label: 'üèÜ Streak Maximum',
                            value: 'max_streak',
                            description: 'Limite du syst√®me de streak'
                        },
                        {
                            label: 'üîÑ Reset Daily',
                            value: 'reset_daily',
                            description: 'Remettre √† z√©ro les streaks'
                        }
                    ]
                }
            ]);

        await interaction.update({ embeds: [embed], components: [row] });
    }

    /**
     * Configuration des r√©compenses par message
     */
    async showMessagesConfig(interaction) {
        const messageConfig = await this.dataManager.loadData('message_rewards.json', {
            enabled: false,
            amountPerMessage: 5,
            cooldownMinutes: 1
        });

        const embed = new EmbedBuilder()
            .setColor('#1abc9c')
            .setTitle('üí¨ Configuration Messages')
            .setDescription('R√©compenses automatiques pour les messages')
            .addFields([
                { 
                    name: 'üéØ Statut', 
                    value: messageConfig.enabled ? '‚úÖ Activ√©' : '‚ùå D√©sactiv√©', 
                    inline: true 
                },
                { 
                    name: 'üí∞ Montant par message', 
                    value: `${messageConfig.amountPerMessage}‚Ç¨`, 
                    inline: true 
                },
                { 
                    name: '‚è∞ Cooldown', 
                    value: `${messageConfig.cooldownMinutes} minute(s)`, 
                    inline: true 
                }
            ]);

        const row = new ActionRowBuilder()
            .addComponents([
                {
                    type: 3,
                    customId: 'economy_messages_options',
                    placeholder: 'Choisissez une option...',
                    options: [
                        {
                            label: messageConfig.enabled ? '‚ùå D√©sactiver' : '‚úÖ Activer',
                            value: 'toggle_messages',
                            description: 'Activer/d√©sactiver le syst√®me'
                        },
                        {
                            label: 'üí∞ Montant par Message',
                            value: 'message_amount',
                            description: 'Modifier la r√©compense'
                        },
                        {
                            label: '‚è∞ Cooldown Messages',
                            value: 'message_cooldown',
                            description: 'Temps entre r√©compenses'
                        },
                        {
                            label: 'üìä Statistiques Messages',
                            value: 'message_stats',
                            description: 'Voir les donn√©es actuelles'
                        }
                    ]
                }
            ]);

        await interaction.update({ embeds: [embed], components: [row] });
    }

    /**
     * Configuration des statistiques
     */
    async showStatsConfig(interaction) {
        const economy = await this.dataManager.loadData('economy.json', {});
        const totalUsers = Object.keys(economy).length;
        const totalBalance = Object.values(economy).reduce((sum, user) => sum + (user.balance || 0), 0);

        const embed = new EmbedBuilder()
            .setColor('#34495e')
            .setTitle('üìä Statistiques du Syst√®me')
            .setDescription('Donn√©es actuelles du syst√®me √©conomique')
            .addFields([
                { name: 'üë• Utilisateurs total', value: totalUsers.toString(), inline: true },
                { name: 'üí∞ Argent en circulation', value: `${totalBalance.toLocaleString()}‚Ç¨`, inline: true },
                { name: 'üìà Moyenne par utilisateur', value: `${Math.round(totalBalance / Math.max(totalUsers, 1))}‚Ç¨`, inline: true }
            ]);

        const row = new ActionRowBuilder()
            .addComponents([
                {
                    type: 3,
                    customId: 'economy_stats_options',
                    placeholder: 'Choisissez une option...',
                    options: [
                        {
                            label: 'üìä Voir Statistiques D√©taill√©es',
                            value: 'detailed_stats',
                            description: 'Toutes les donn√©es du syst√®me'
                        },
                        {
                            label: 'üíæ Sauvegarder Donn√©es',
                            value: 'backup_data',
                            description: 'Cr√©er une sauvegarde manuelle'
                        },
                        {
                            label: 'üîÑ Reset √âconomie',
                            value: 'reset_economy',
                            description: 'DANGER: Remettre √† z√©ro tout'
                        },
                        {
                            label: 'üì• Importer/Exporter',
                            value: 'import_export',
                            description: 'Gestion des donn√©es'
                        }
                    ]
                }
            ]);

        await interaction.update({ embeds: [embed], components: [row] });
    }
}

module.exports = EconomyConfigHandler;