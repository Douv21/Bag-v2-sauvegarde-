/**
 * GESTIONNAIRE D'INTERACTIONS CENTRALIS√â
 * Gestion unifi√©e des menus d√©roulants, boutons et modals
 */

const { EmbedBuilder, ActionRowBuilder, ButtonBuilder, StringSelectMenuBuilder, ButtonStyle } = require('discord.js');

class InteractionHandler {
    constructor(client, dataManager) {
        this.client = client;
        this.dataManager = dataManager;
        
        // Handlers par type d'interaction
        this.handlers = {
            // Menus d√©roulants
            selectMenu: new Map(),
            
            // Boutons
            button: new Map(),
            
            // Modals
            modal: new Map()
        };
        
        this.registerHandlers();
    }

    registerHandlers() {
        // === CONFIGURATION √âCONOMIE ===
        this.handlers.selectMenu.set('economy_main_config', this.handleEconomyMainConfig.bind(this));
        this.handlers.selectMenu.set('economy_action_config', this.handleEconomyActionConfig.bind(this));
        this.handlers.selectMenu.set('karma_config_menu', this.handleKarmaConfigMenu.bind(this));
        this.handlers.selectMenu.set('shop_purchase', this.handleShopPurchase.bind(this));
        
        // === CONFESSION SYSTEM ===
        this.handlers.selectMenu.set('config_main_menu', this.handleConfigMainMenu.bind(this));
        
        // === BOUTONS ===
        this.handlers.button.set('economy_back_main', this.handleBackToMain.bind(this));
        this.handlers.button.set('config_back_main', this.handleBackToMain.bind(this));
        this.handlers.button.set('edit_reward_work', this.handleEditReward.bind(this));
        this.handlers.button.set('edit_karma_work', this.handleEditKarma.bind(this));
        this.handlers.button.set('edit_cooldown_work', this.handleEditCooldown.bind(this));
        this.handlers.button.set('edit_reward_fish', this.handleEditReward.bind(this));
        this.handlers.button.set('edit_karma_fish', this.handleEditKarma.bind(this));
        this.handlers.button.set('edit_cooldown_fish', this.handleEditCooldown.bind(this));
        this.handlers.button.set('edit_reward_donate', this.handleEditReward.bind(this));
        this.handlers.button.set('edit_karma_donate', this.handleEditKarma.bind(this));
        this.handlers.button.set('edit_cooldown_donate', this.handleEditCooldown.bind(this));
        this.handlers.button.set('edit_reward_steal', this.handleEditReward.bind(this));
        this.handlers.button.set('edit_karma_steal', this.handleEditKarma.bind(this));
        this.handlers.button.set('edit_cooldown_steal', this.handleEditCooldown.bind(this));
        this.handlers.button.set('edit_reward_crime', this.handleEditReward.bind(this));
        this.handlers.button.set('edit_karma_crime', this.handleEditKarma.bind(this));
        this.handlers.button.set('edit_cooldown_crime', this.handleEditCooldown.bind(this));
        this.handlers.button.set('edit_reward_bet', this.handleEditReward.bind(this));
        this.handlers.button.set('edit_karma_bet', this.handleEditKarma.bind(this));
        this.handlers.button.set('edit_cooldown_bet', this.handleEditCooldown.bind(this));
        this.handlers.button.set('economy_back_actions', this.handleBackToActions.bind(this));
        this.handlers.button.set('toggle_message_rewards', this.handleToggleMessageRewards.bind(this));
        this.handlers.button.set('karma_force_reset', this.handleKarmaForceReset.bind(this));
    }

    async handle(interaction) {
        try {
            // Commandes slash
            if (interaction.isChatInputCommand()) {
                await this.handleCommand(interaction);
                return;
            }

            // Menus d√©roulants
            if (interaction.isStringSelectMenu()) {
                await this.handleSelectMenu(interaction);
                return;
            }

            // Boutons
            if (interaction.isButton()) {
                await this.handleButton(interaction);
                return;
            }

            // Modals
            if (interaction.isModalSubmit()) {
                await this.handleModal(interaction);
                return;
            }

        } catch (error) {
            console.error('‚ùå Erreur interaction:', error);
            await this.sendErrorResponse(interaction, error);
        }
    }

    async handleCommand(interaction) {
        const command = this.client.commands.get(interaction.commandName);
        if (!command) return;

        try {
            await command.execute(interaction, this.dataManager);
        } catch (error) {
            console.error(`‚ùå Erreur commande ${interaction.commandName}:`, error);
            await this.sendErrorResponse(interaction, error);
        }
    }

    async handleSelectMenu(interaction) {
        const handler = this.handlers.selectMenu.get(interaction.customId);
        if (handler) {
            await handler(interaction);
        } else {
            console.log(`‚ö†Ô∏è Menu non g√©r√©: ${interaction.customId}`);
        }
    }

    async handleButton(interaction) {
        const handler = this.handlers.button.get(interaction.customId);
        if (handler) {
            await handler(interaction);
        } else {
            console.log(`‚ö†Ô∏è Bouton non g√©r√©: ${interaction.customId}`);
        }
    }

    async handleModal(interaction) {
        const handler = this.handlers.modal.get(interaction.customId);
        if (handler) {
            await handler(interaction);
        } else {
            console.log(`‚ö†Ô∏è Modal non g√©r√©: ${interaction.customId}`);
        }
    }

    // === HANDLERS SP√âCIFIQUES ===

    async handleEconomyMainConfig(interaction) {
        const value = interaction.values[0];
        
        switch (value) {
            case 'actions':
                await this.showActionsConfig(interaction);
                break;
            case 'shop':
                await this.showShopConfig(interaction);
                break;
            case 'karma':
                await this.showKarmaConfig(interaction);
                break;
            case 'daily':
                await this.showDailyConfig(interaction);
                break;
            case 'messages':
                await this.showMessageRewardsConfig(interaction);
                break;
            default:
                await this.sendNotImplemented(interaction, value);
        }
    }

    async handleEconomyActionConfig(interaction) {
        const action = interaction.values[0];
        await this.showActionSettings(interaction, action);
    }

    async handleConfigMainMenu(interaction) {
        const value = interaction.values[0];
        
        switch(value) {
            case 'channels':
                await this.showChannelsConfig(interaction);
                break;
            case 'autothread':
                await this.showAutoThreadConfig(interaction);
                break;
            case 'logs':
                await this.showLogsConfig(interaction);
                break;
            default:
                await interaction.reply({
                    content: `Configuration ${value} disponible bient√¥t.`,
                    flags: 64
                });
        }
    }

    async handleKarmaConfigMenu(interaction) {
        const value = interaction.values[0];
        
        switch(value) {
            case 'levels':
                await this.showKarmaLevelsConfig(interaction);
                break;
            case 'reset':
                await this.showKarmaResetConfig(interaction);
                break;
            case 'actions':
                await this.showKarmaActionsConfig(interaction);
                break;
            default:
                await interaction.reply({
                    content: `Configuration ${value} en cours de d√©veloppement.`,
                    flags: 64
                });
        }
    }

    async handleShopPurchase(interaction) {
        const itemId = interaction.values[0];
        
        await interaction.reply({
            content: `Achat d'objet ${itemId} en cours de d√©veloppement.`,
            flags: 64
        });
    }

    // === HANDLERS BOUTONS ===

    async handleEditReward(interaction) {
        const action = interaction.customId.split('_')[2]; // extract action from button id
        await interaction.reply({
            content: `üí∞ Modification des r√©compenses pour l'action ${action} en cours de d√©veloppement.\n\nProchainement vous pourrez configurer:\n‚Ä¢ Montant minimum\n‚Ä¢ Montant maximum\n‚Ä¢ Bonus selon le karma`,
            flags: 64
        });
    }

    async handleEditKarma(interaction) {
        const action = interaction.customId.split('_')[2]; // extract action from button id
        await interaction.reply({
            content: `‚öñÔ∏è Configuration karma pour l'action ${action} en cours de d√©veloppement.\n\nProchainement vous pourrez configurer:\n‚Ä¢ Karma bon gagn√© (üòá)\n‚Ä¢ Karma mauvais gagn√© (üòà)\n‚Ä¢ Multiplicateurs selon le niveau`,
            flags: 64
        });
    }

    async handleEditCooldown(interaction) {
        const action = interaction.customId.split('_')[2]; // extract action from button id
        await interaction.reply({
            content: `‚è∞ Configuration cooldown pour l'action ${action} en cours de d√©veloppement.\n\nProchainement vous pourrez configurer:\n‚Ä¢ Dur√©e du cooldown\n‚Ä¢ R√©duction selon le karma\n‚Ä¢ Cooldown global ou par utilisateur`,
            flags: 64
        });
    }

    async handleBackToActions(interaction) {
        await this.showActionsConfig(interaction);
    }

    async handleToggleMessageRewards(interaction) {
        await interaction.reply({
            content: 'Toggle r√©compenses messages en cours de d√©veloppement.',
            flags: 64
        });
    }

    async handleKarmaForceReset(interaction) {
        await interaction.reply({
            content: 'üîÑ Reset karma forc√© en cours de d√©veloppement.\n\nCette action va :\n‚Ä¢ Distribuer les r√©compenses actuelles\n‚Ä¢ Remettre tous les karma √† 0\n‚Ä¢ Logger l\'action dans les statistiques',
            flags: 64
        });
    }

    async handleBackToMain(interaction) {
        // Retour au menu principal selon le contexte
        if (interaction.customId.includes('economy')) {
            // Recharger config √©conomie
            const command = this.client.commands.get('configeconomie');
            if (command) {
                await command.showMainEconomyConfig(interaction);
            }
        } else {
            // Recharger config g√©n√©rale
            const command = this.client.commands.get('config');
            if (command) {
                await command.showMainConfig(interaction);
            }
        }
    }

    // === M√âTHODES D'AFFICHAGE ===

    async showActionsConfig(interaction) {
        const embed = new EmbedBuilder()
            .setColor('#9932cc')
            .setTitle('üíº Configuration Actions √âconomiques')
            .setDescription('Configurez toutes les actions avec karma param√©trable et r√©compenses automatiques')
            .addFields([
                {
                    name: 'üòá Actions Positives',
                    value: '**Travailler** (+1üòá -1üòà)\n**P√™cher** (+1üòá -1üòà)\n**Donner** (+3üòá -2üòà)',
                    inline: true
                },
                {
                    name: 'üòà Actions N√©gatives', 
                    value: '**Voler** (-1üòá +1üòà)\n**Crime** (-3üòá +3üòà)\n**Parier** (-1üòá +1üòà)',
                    inline: true
                },
                {
                    name: '‚öñÔ∏è Syst√®me Automatique',
                    value: 'R√©compenses/sanctions selon karma\nReset hebdomadaire configurable\nMultiplicateurs bonus/malus',
                    inline: false
                }
            ]);

        const selectMenu = new StringSelectMenuBuilder()
            .setCustomId('economy_action_config')
            .setPlaceholder('üíº S√©lectionner une action √† configurer')
            .addOptions([
                {
                    label: 'Travailler üíº',
                    description: 'Gains: 100-150‚Ç¨ | Karma: +1üòá | Cooldown: 1h',
                    value: 'work',
                    emoji: 'üíº'
                },
                {
                    label: 'P√™cher üé£',
                    description: 'Gains variables | Karma: +1üòá | Cooldown: 1h30',
                    value: 'fish',
                    emoji: 'üé£'
                },
                {
                    label: 'Donner üíù',
                    description: 'Transfert argent | Karma: +3üòá | Cooldown: 1h',
                    value: 'donate',
                    emoji: 'üíù'
                },
                {
                    label: 'Voler üí∏',
                    description: 'Vol avec risque | Karma: +1üòà | Cooldown: 2h',
                    value: 'steal',
                    emoji: 'üí∏'
                },
                {
                    label: 'Crime üî´',
                    description: 'Gros gains/risques | Karma: +3üòà | Cooldown: 4h',
                    value: 'crime',
                    emoji: 'üî´'
                },
                {
                    label: 'Parier üé∞',
                    description: 'Gambling 45% | Karma: +1üòà | Cooldown: 30min',
                    value: 'bet',
                    emoji: 'üé∞'
                }
            ]);

        const components = [new ActionRowBuilder().addComponents(selectMenu)];

        await this.safeReply(interaction, {
            embeds: [embed],
            components: components
        });
    }

    async showActionSettings(interaction, action) {
        const actionConfig = {
            work: {
                name: 'Travailler üíº',
                description: 'Action positive qui g√©n√®re de l\'argent et du karma bon',
                currentSettings: {
                    minReward: 100,
                    maxReward: 150,
                    karmaGood: 1,
                    karmaBad: 0,
                    cooldown: 3600000 // 1h en ms
                }
            },
            fish: {
                name: 'P√™cher üé£',
                description: 'Action positive avec gains variables selon la chance',
                currentSettings: {
                    minReward: 50,
                    maxReward: 200,
                    karmaGood: 1,
                    karmaBad: 0,
                    cooldown: 5400000 // 1h30 en ms
                }
            },
            donate: {
                name: 'Donner üíù',
                description: 'Action tr√®s positive qui transf√®re de l\'argent',
                currentSettings: {
                    minReward: 0,
                    maxReward: 0,
                    karmaGood: 3,
                    karmaBad: 0,
                    cooldown: 3600000 // 1h en ms
                }
            },
            steal: {
                name: 'Voler üí∏',
                description: 'Action n√©gative avec risques et r√©compenses',
                currentSettings: {
                    minReward: 50,
                    maxReward: 100,
                    karmaGood: 0,
                    karmaBad: 1,
                    cooldown: 7200000 // 2h en ms
                }
            },
            crime: {
                name: 'Crime üî´',
                description: 'Action tr√®s n√©gative avec gros gains mais gros risques',
                currentSettings: {
                    minReward: 200,
                    maxReward: 500,
                    karmaGood: 0,
                    karmaBad: 3,
                    cooldown: 14400000 // 4h en ms
                }
            },
            bet: {
                name: 'Parier üé∞',
                description: 'Action n√©gative de gambling avec 45% de chance',
                currentSettings: {
                    minReward: 0,
                    maxReward: 200,
                    karmaGood: 0,
                    karmaBad: 1,
                    cooldown: 1800000 // 30min en ms
                }
            }
        };

        const config = actionConfig[action];
        if (!config) {
            await interaction.reply({
                content: 'Action non trouv√©e.',
                flags: 64
            });
            return;
        }

        const cooldownHours = Math.floor(config.currentSettings.cooldown / 3600000);
        const cooldownMins = Math.floor((config.currentSettings.cooldown % 3600000) / 60000);
        const cooldownText = cooldownHours > 0 ? `${cooldownHours}h${cooldownMins > 0 ? cooldownMins + 'min' : ''}` : `${cooldownMins}min`;

        const embed = new EmbedBuilder()
            .setColor('#9932cc')
            .setTitle(`‚öôÔ∏è Configuration: ${config.name}`)
            .setDescription(config.description)
            .addFields([
                {
                    name: 'üí∞ R√©compenses',
                    value: config.currentSettings.minReward === config.currentSettings.maxReward 
                        ? `**${config.currentSettings.minReward}‚Ç¨**`
                        : `**${config.currentSettings.minReward}‚Ç¨** - **${config.currentSettings.maxReward}‚Ç¨**`,
                    inline: true
                },
                {
                    name: '‚öñÔ∏è Karma',
                    value: `üòá +${config.currentSettings.karmaGood} | üòà +${config.currentSettings.karmaBad}`,
                    inline: true
                },
                {
                    name: '‚è∞ Cooldown',
                    value: `**${cooldownText}**`,
                    inline: true
                }
            ]);

        const buttons = [
            new ButtonBuilder()
                .setCustomId(`edit_reward_${action}`)
                .setLabel('Modifier R√©compenses')
                .setStyle(ButtonStyle.Primary)
                .setEmoji('üí∞'),
            new ButtonBuilder()
                .setCustomId(`edit_karma_${action}`)
                .setLabel('Modifier Karma')
                .setStyle(ButtonStyle.Secondary)
                .setEmoji('‚öñÔ∏è'),
            new ButtonBuilder()
                .setCustomId(`edit_cooldown_${action}`)
                .setLabel('Modifier Cooldown')
                .setStyle(ButtonStyle.Secondary)
                .setEmoji('‚è∞'),
            new ButtonBuilder()
                .setCustomId('economy_back_actions')
                .setLabel('Retour')
                .setStyle(ButtonStyle.Danger)
                .setEmoji('‚Ü©Ô∏è')
        ];

        const components = [new ActionRowBuilder().addComponents(buttons)];

        await this.safeReply(interaction, {
            embeds: [embed],
            components: components
        });
    }

    async showKarmaConfig(interaction) {
        const embed = new EmbedBuilder()
            .setColor('#9932cc')
            .setTitle('‚öñÔ∏è Configuration Syst√®me Karma Avanc√©')
            .setDescription('Syst√®me automatique avec r√©compenses/sanctions et reset hebdomadaire')
            .addFields([
                {
                    name: 'üèÜ Niveaux et R√©compenses',
                    value: '**üòá Saint** (+10+): +500‚Ç¨, x1.5 daily, -30% cooldown\n**üòá Bon** (+1/+9): +200‚Ç¨, x1.2 daily, -10% cooldown\n**üòê Neutre** (0): Aucun effet\n**üòà Mauvais** (-1/-9): -100‚Ç¨, x0.8 daily, +20% cooldown\n**üòà Diabolique** (-10-): -300‚Ç¨, x0.5 daily, +50% cooldown',
                    inline: false
                },
                {
                    name: 'üìÖ Reset Automatique',
                    value: 'Reset chaque semaine (configurable)\nR√©compenses distribu√©es avant reset\nTous les karma remis √† 0',
                    inline: true
                },
                {
                    name: '‚öôÔ∏è Actions Configurables',
                    value: 'Gains karma bon/mauvais par action\nEffets personnalisables\nActivation/d√©sactivation par action',
                    inline: true
                }
            ]);

        const selectMenu = new StringSelectMenuBuilder()
            .setCustomId('karma_config_menu')
            .setP
