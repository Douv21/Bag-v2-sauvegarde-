const { ChannelType, PermissionFlagsBits } = require('discord.js');

class QuarantineChannelManager {
  constructor(moderationManager) {
    this.moderationManager = moderationManager;
    this.quarantineChannels = new Map(); // userId -> { textChannel, voiceChannel }
  }

  /**
   * Cr√©er des canaux de quarantaine pour un membre
   * @param {GuildMember} member - Le membre √† mettre en quarantaine
   * @param {String} reason - Raison de la quarantaine
   * @returns {Object} Les canaux cr√©√©s
   */
  async createQuarantineChannels(member, reason = 'Quarantaine automatique') {
    try {
      const config = await this.moderationManager.getSecurityConfig(member.guild.id);
      const quarantineRoleId = config.accessControl?.quarantineRoleId;
      
      if (!quarantineRoleId) {
        throw new Error('R√¥le de quarantaine non configur√©');
      }

      const quarantineRole = member.guild.roles.cache.get(quarantineRoleId);
      if (!quarantineRole) {
        throw new Error('R√¥le de quarantaine introuvable');
      }

      // Cr√©er ou r√©cup√©rer la cat√©gorie de quarantaine
      const category = await this.getOrCreateQuarantineCategory(member.guild);

      // Cr√©er le canal texte
      const textChannel = await member.guild.channels.create({
        name: `quarantaine-${member.user.username.toLowerCase().replace(/[^a-z0-9]/g, '')}-${member.user.discriminator}`,
        type: ChannelType.GuildText,
        parent: category,
        topic: `Quarantaine de ${member.user.tag} - ${reason}`,
        permissionOverwrites: [
          {
            id: member.guild.roles.everyone.id,
            deny: [PermissionFlagsBits.ViewChannel]
          },
          {
            id: member.user.id,
            allow: [
              PermissionFlagsBits.ViewChannel,
              PermissionFlagsBits.SendMessages,
              PermissionFlagsBits.ReadMessageHistory,
              PermissionFlagsBits.AddReactions
            ]
          },
          {
            id: quarantineRoleId,
            allow: [PermissionFlagsBits.ViewChannel]
          },
          // Permissions pour les mod√©rateurs
          ...this.getModeratorPermissions(member.guild, config)
        ]
      });

      // Cr√©er le canal vocal
      const voiceChannel = await member.guild.channels.create({
        name: `üîí Quarantaine ${member.user.username}`,
        type: ChannelType.GuildVoice,
        parent: category,
        permissionOverwrites: [
          {
            id: member.guild.roles.everyone.id,
            deny: [PermissionFlagsBits.ViewChannel]
          },
          {
            id: member.user.id,
            allow: [
              PermissionFlagsBits.ViewChannel,
              PermissionFlagsBits.Connect,
              PermissionFlagsBits.Speak,
              PermissionFlagsBits.UseVAD
            ]
          },
          {
            id: quarantineRoleId,
            allow: [PermissionFlagsBits.ViewChannel]
          },
          // Permissions pour les mod√©rateurs
          ...this.getModeratorPermissions(member.guild, config)
        ]
      });

      // Configurer les permissions du r√¥le de quarantaine sur tous les canaux
      await this.configureQuarantineRolePermissions(member.guild, quarantineRole);

      // Ajouter le r√¥le de quarantaine
      await member.roles.add(quarantineRole, reason);

      // Enregistrer les canaux
      this.quarantineChannels.set(member.user.id, {
        textChannel,
        voiceChannel,
        createdAt: Date.now(),
        reason
      });

      // Envoyer message de bienvenue dans le canal texte
      await this.sendWelcomeMessage(textChannel, member, reason);

      console.log(`üîí Canaux de quarantaine cr√©√©s pour ${member.user.tag}`);
      return { textChannel, voiceChannel };

    } catch (error) {
      console.error('Erreur cr√©ation canaux quarantaine:', error);
      throw error;
    }
  }

  /**
   * Lib√©rer un membre de la quarantaine
   * @param {GuildMember} member - Le membre √† lib√©rer
   * @param {String} reason - Raison de la lib√©ration
   */
  async releaseFromQuarantine(member, reason = 'Lib√©r√© par un administrateur') {
    try {
      const config = await this.moderationManager.getSecurityConfig(member.guild.id);
      const quarantineRoleId = config.accessControl?.quarantineRoleId;
      const verifiedRoleId = config.accessControl?.verifiedRoleId;

      // Retirer le r√¥le de quarantaine
      if (quarantineRoleId) {
        const quarantineRole = member.guild.roles.cache.get(quarantineRoleId);
        if (quarantineRole && member.roles.cache.has(quarantineRoleId)) {
          await member.roles.remove(quarantineRole, reason);
        }
      }

      // Ajouter le r√¥le v√©rifi√©
      if (verifiedRoleId) {
        const verifiedRole = member.guild.roles.cache.get(verifiedRoleId);
        if (verifiedRole) {
          await member.roles.add(verifiedRole, reason);
        }
      }

      // Supprimer les canaux de quarantaine
      await this.deleteQuarantineChannels(member.user.id);

      // Notifier le membre
      try {
        await member.send(
          `‚úÖ **Lib√©r√© de quarantaine - ${member.guild.name}**\n\n` +
          `Vous avez √©t√© lib√©r√© de la quarantaine.\n` +
          `**Raison :** ${reason}\n\n` +
          `Vous avez maintenant acc√®s √† tous les canaux autoris√©s. Bienvenue !`
        );
      } catch {}

      console.log(`‚úÖ ${member.user.tag} lib√©r√© de quarantaine`);

    } catch (error) {
      console.error('Erreur lib√©ration quarantaine:', error);
      throw error;
    }
  }

  /**
   * Supprimer les canaux de quarantaine d'un membre
   * @param {String} userId - ID de l'utilisateur
   */
  async deleteQuarantineChannels(userId) {
    try {
      const channels = this.quarantineChannels.get(userId);
      if (!channels) return;

      // Supprimer le canal texte
      if (channels.textChannel) {
        try {
          await channels.textChannel.delete('Fin de quarantaine');
        } catch (error) {
          console.error('Erreur suppression canal texte:', error);
        }
      }

      // Supprimer le canal vocal
      if (channels.voiceChannel) {
        try {
          await channels.voiceChannel.delete('Fin de quarantaine');
        } catch (error) {
          console.error('Erreur suppression canal vocal:', error);
        }
      }

      // Retirer de la map
      this.quarantineChannels.delete(userId);

    } catch (error) {
      console.error('Erreur suppression canaux:', error);
    }
  }

  /**
   * Obtenir ou cr√©er la cat√©gorie de quarantaine
   * @param {Guild} guild - Le serveur
   * @returns {CategoryChannel} La cat√©gorie
   */
  async getOrCreateQuarantineCategory(guild) {
    // Chercher une cat√©gorie existante
    let category = guild.channels.cache.find(
      c => c.type === ChannelType.GuildCategory && 
      c.name.toLowerCase().includes('quarantaine')
    );

    if (!category) {
      // Cr√©er la cat√©gorie
      category = await guild.channels.create({
        name: 'üîí QUARANTAINE',
        type: ChannelType.GuildCategory,
        permissionOverwrites: [
          {
            id: guild.roles.everyone.id,
            deny: [PermissionFlagsBits.ViewChannel]
          }
        ]
      });
    }

    return category;
  }

  /**
   * Configurer les permissions du r√¥le de quarantaine sur tous les canaux
   * @param {Guild} guild - Le serveur
   * @param {Role} quarantineRole - Le r√¥le de quarantaine
   */
  async configureQuarantineRolePermissions(guild, quarantineRole) {
    try {
      console.log(`üîß Configuration des permissions du r√¥le de quarantaine: ${quarantineRole.name}`);
      
      // Obtenir tous les canaux du serveur (sauf les canaux de quarantaine)
      const channels = guild.channels.cache.filter(channel => {
        // Exclure les canaux de quarantaine
        if (channel.parent && channel.parent.name.toLowerCase().includes('quarantaine')) {
          return false;
        }
        if (channel.name.toLowerCase().includes('quarantaine')) {
          return false;
        }
        // Inclure seulement les canaux texte, vocaux et cat√©gories
        return [ChannelType.GuildText, ChannelType.GuildVoice, ChannelType.GuildCategory].includes(channel.type);
      });

      let configuredCount = 0;
      const errors = [];

      for (const channel of channels.values()) {
        try {
          // V√©rifier si le r√¥le a d√©j√† des permissions configur√©es sur ce canal
          const existingOverwrite = channel.permissionOverwrites.cache.get(quarantineRole.id);
          
          if (!existingOverwrite || !existingOverwrite.deny.has(PermissionFlagsBits.ViewChannel)) {
            // Configurer les permissions pour refuser l'acc√®s
            await channel.permissionOverwrites.edit(quarantineRole, {
              ViewChannel: false,
              SendMessages: false,
              Connect: false,
              Speak: false,
              SendMessagesInThreads: false,
              CreatePrivateThreads: false,
              CreatePublicThreads: false,
              UseEmbeddedActivities: false,
              UseApplicationCommands: false
            }, {
              reason: 'Configuration automatique du r√¥le de quarantaine'
            });
            
            configuredCount++;
          }
        } catch (channelError) {
          errors.push(`${channel.name}: ${channelError.message}`);
        }
      }

      console.log(`‚úÖ Permissions configur√©es sur ${configuredCount} canaux pour le r√¥le ${quarantineRole.name}`);
      
      if (errors.length > 0) {
        console.warn(`‚ö†Ô∏è Erreurs de configuration sur ${errors.length} canaux:`, errors.slice(0, 5));
      }

    } catch (error) {
      console.error('Erreur configuration permissions quarantaine:', error);
      throw new Error(`Impossible de configurer les permissions du r√¥le de quarantaine: ${error.message}`);
    }
  }

  /**
   * Obtenir les permissions pour les mod√©rateurs
   * @param {Guild} guild - Le serveur
   * @param {Object} config - Configuration de s√©curit√©
   * @returns {Array} Permissions overwrites
   */
  getModeratorPermissions(guild, config) {
    const permissions = [];

    // Permissions pour le r√¥le admin configur√©
    if (config.autoAlerts?.moderatorRoleId) {
      permissions.push({
        id: config.autoAlerts.moderatorRoleId,
        allow: [
          PermissionFlagsBits.ViewChannel,
          PermissionFlagsBits.SendMessages,
          PermissionFlagsBits.ReadMessageHistory,
          PermissionFlagsBits.ManageMessages,
          PermissionFlagsBits.Connect,
          PermissionFlagsBits.Speak,
          PermissionFlagsBits.MuteMembers,
          PermissionFlagsBits.DeafenMembers
        ]
      });
    }

    // Permissions pour les administrateurs
    permissions.push({
      id: guild.roles.cache.find(r => r.permissions.has(PermissionFlagsBits.Administrator))?.id || guild.ownerId,
      allow: [
        PermissionFlagsBits.ViewChannel,
        PermissionFlagsBits.SendMessages,
        PermissionFlagsBits.ReadMessageHistory,
        PermissionFlagsBits.ManageMessages,
        PermissionFlagsBits.ManageChannels,
        PermissionFlagsBits.Connect,
        PermissionFlagsBits.Speak,
        PermissionFlagsBits.MuteMembers,
        PermissionFlagsBits.DeafenMembers
      ]
    });

    return permissions;
  }

  /**
   * Envoyer le message de bienvenue dans le canal de quarantaine
   * @param {TextChannel} channel - Canal texte
   * @param {GuildMember} member - Membre en quarantaine
   * @param {String} reason - Raison de la quarantaine
   */
  async sendWelcomeMessage(channel, member, reason) {
    try {
      await channel.send({
        content: `üîí **Quarantaine - ${member.user.tag}**`,
        embeds: [{
          title: 'üîí Vous √™tes en quarantaine',
          description: `Bonjour ${member.user}, vous avez √©t√© plac√© en quarantaine pour v√©rification.`,
          color: 0xffd43b,
          fields: [
            {
              name: 'üìã Raison',
              value: reason,
              inline: false
            },
            {
              name: 'üìç O√π vous √™tes',
              value: `‚Ä¢ **Canal texte :** ${channel}\n‚Ä¢ **Canal vocal :** Disponible dans cette cat√©gorie\n‚Ä¢ **Acc√®s :** Limit√© √† ces canaux uniquement`,
              inline: false
            },
            {
              name: '‚è∞ Que faire maintenant ?',
              value: `‚Ä¢ Attendez qu'un administrateur examine votre cas\n‚Ä¢ Vous pouvez utiliser ce canal pour communiquer\n‚Ä¢ Respectez les r√®gles du serveur\n‚Ä¢ Soyez patient, nous traiterons votre cas rapidement`,
              inline: false
            },
            {
              name: 'üÜò Besoin d\'aide ?',
              value: `Utilisez ce canal pour poser vos questions aux mod√©rateurs.\nIls recevront une notification de votre message.`,
              inline: false
            }
          ],
          footer: {
            text: 'Syst√®me de quarantaine automatique',
            icon_url: member.guild.iconURL()
          },
          timestamp: new Date().toISOString()
        }]
      });

      // Ping les mod√©rateurs
      const config = await this.moderationManager.getSecurityConfig(member.guild.id);
      if (config.autoAlerts?.moderatorRoleId) {
        await channel.send(`<@&${config.autoAlerts.moderatorRoleId}> Un nouveau membre est en quarantaine et peut avoir besoin d'assistance.`);
      }

    } catch (error) {
      console.error('Erreur envoi message bienvenue:', error);
    }
  }

  /**
   * Nettoyer les canaux de quarantaine orphelins
   * @param {Guild} guild - Le serveur
   */
  async cleanupOrphanedChannels(guild) {
    try {
      const category = guild.channels.cache.find(
        c => c.type === ChannelType.GuildCategory && 
        c.name.toLowerCase().includes('quarantaine')
      );

      if (!category) return;

      const config = await this.moderationManager.getSecurityConfig(guild.id);
      const quarantineRoleId = config.accessControl?.quarantineRoleId;

      if (!quarantineRoleId) return;

      // Trouver les canaux de quarantaine
      const quarantineChannels = category.children.cache.filter(
        c => c.name.includes('quarantaine-') || c.name.includes('üîí Quarantaine')
      );

      for (const channel of quarantineChannels.values()) {
        // V√©rifier si le membre correspondant existe encore et a le r√¥le
        const userIdMatch = channel.name.match(/quarantaine-(.+?)-\d{4}/) || 
                           channel.name.match(/üîí Quarantaine (.+)/);
        
        if (userIdMatch) {
          const username = userIdMatch[1];
          const member = guild.members.cache.find(m => 
            m.user.username.toLowerCase().replace(/[^a-z0-9]/g, '') === username ||
            m.user.username === username
          );

          // Si le membre n'existe plus ou n'a plus le r√¥le, supprimer le canal
          if (!member || !member.roles.cache.has(quarantineRoleId)) {
            try {
              await channel.delete('Nettoyage automatique - membre non trouv√© ou sans r√¥le');
              console.log(`üßπ Canal de quarantaine orphelin supprim√©: ${channel.name}`);
            } catch (error) {
              console.error('Erreur suppression canal orphelin:', error);
            }
          }
        }
      }

    } catch (error) {
      console.error('Erreur nettoyage canaux orphelins:', error);
    }
  }

  /**
   * Obtenir les informations de quarantaine d'un membre
   * @param {String} userId - ID de l'utilisateur
   * @returns {Object|null} Informations de quarantaine
   */
  getQuarantineInfo(userId) {
    return this.quarantineChannels.get(userId) || null;
  }

  /**
   * Lister tous les membres en quarantaine
   * @param {Guild} guild - Le serveur
   * @returns {Array} Liste des membres en quarantaine
   */
  async listQuarantinedMembers(guild) {
    try {
      const config = await this.moderationManager.getSecurityConfig(guild.id);
      const quarantineRoleId = config.accessControl?.quarantineRoleId;

      if (!quarantineRoleId) return [];

      const quarantineRole = guild.roles.cache.get(quarantineRoleId);
      if (!quarantineRole) return [];

      return quarantineRole.members.map(member => ({
        member,
        channels: this.getQuarantineInfo(member.user.id),
        duration: this.getQuarantineInfo(member.user.id)?.createdAt ? 
          Date.now() - this.getQuarantineInfo(member.user.id).createdAt : 0
      }));

    } catch (error) {
      console.error('Erreur liste membres quarantaine:', error);
      return [];
    }
  }
}

module.exports = QuarantineChannelManager;