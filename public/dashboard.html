<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAG v2 — Tableau de bord</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0a0a0a; color:#ffffff; display:flex; align-items:center; justify-content:center; min-height:100vh; margin:0; }
        .box { text-align:center; padding:2rem; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:12px; max-width:760px; width:90%; }
        h1 { margin:0 0 0.5rem; font-size:1.8rem; }
        p { color:#bbbbbb; margin:0.5rem 0 1rem; }
        a { color:#ff6666; text-decoration:none; }
        .links { margin-top:1rem; display:flex; gap:0.75rem; justify-content:center; flex-wrap:wrap; }
        .btn { padding:0.6rem 1rem; border-radius:8px; background:#1a1a1a; border:1px solid #333333; color:#ffffff; }
        .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:1rem; margin-top:1.25rem; text-align:left; }
        .card { background:#111111; border:1px solid #2a2a2a; border-radius:10px; padding:1rem; }
        .card h3 { margin:0 0 .5rem; font-size:1.1rem; }
        .kv { display:flex; justify-content:space-between; gap:1rem; padding:.25rem 0; color:#cccccc; }
        .muted { color:#9a9a9a; }
        .error { color:#ff7777; }
        code { background:#161616; border:1px solid #2a2a2a; padding:2px 6px; border-radius:6px; color:#ddd; }
    </style>
</head>
<body>
    <div class="box">
        <h1>Tableau de bord — BAG v2</h1>
        <p>Version minimale affichant l’état du service et les statistiques clés du serveur.</p>
        <div class="links">
            <a class="btn" href="/public/index.html">Accueil</a>
            <a class="btn" href="/health" target="_blank">Santé (JSON)</a>
            <a class="btn" href="/api/stats" target="_blank">Statistiques (JSON)</a>
        </div>

        <div class="grid">
            <div class="card">
                <h3>État du service</h3>
                <div id="health">
                    <div class="muted">Chargement...</div>
                </div>
            </div>
            <div class="card">
                <h3>Statistiques serveur</h3>
                <div id="stats">
                    <div class="muted">Chargement...</div>
                </div>
            </div>
        </div>

        <div class="muted" style="margin-top:1rem">Fonctions avancées du tableau de bord en cours d’ajout.</div>
    </div>

    <script>
        async function safeJson(url) {
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(String(res.status));
                return await res.json();
            } catch (e) {
                return { __error: e.message };
            }
        }

        function setKV(container, entries) {
            container.innerHTML = entries.map(([k,v]) => `\n                <div class=\"kv\">\n                    <span>${k}</span>\n                    <span>${v}</span>\n                </div>\n            `).join('');
        }

        (async function init() {
            const healthEl = document.getElementById('health');
            const statsEl = document.getElementById('stats');
            const params = new URLSearchParams(window.location.search);
            const guildId = params.get('guildId');

            const [health, stats] = await Promise.all([
                safeJson('/health'),
                safeJson(guildId ? `/api/stats?guildId=${encodeURIComponent(guildId)}` : '/api/stats')
            ]);

            if (health.__error) {
                healthEl.innerHTML = `<div class=\"error\">Erreur: ${health.__error}</div>`;
            } else {
                setKV(healthEl, [
                    ['Statut', health.status || '—'],
                    ['Discord', health.discord || '—'],
                    ['Uptime', (typeof health.uptime === 'number') ? `${Math.floor(health.uptime/3600)}h ${Math.floor((health.uptime%3600)/60)}m` : '—'],
                    ['Serveurs (guildes)', health.guilds ?? '—'],
                    ['Commandes chargées', health.commands ?? '—']
                ]);
            }

            if (stats.__error) {
                statsEl.innerHTML = `<div class=\"error\">Erreur: ${stats.__error}</div>`;
            } else {
                setKV(statsEl, [
                    ['Membres actifs (24h)', stats.activeMembers ?? 0],
                    ['Messages du jour', stats.todayMessages ?? 0],
                    ['Commandes utilisées (jour)', stats.commandsUsed ?? 0],
                    ['Argent total (€)', (typeof stats.totalMoney === 'number') ? stats.totalMoney.toLocaleString('fr-FR') : (stats.totalMoney ?? 0)],
                    ['Utilisateurs total', stats.totalUsers ?? 0],
                    ['Confessions total', stats.totalConfessions ?? 0]
                ]);
            }
        })();
    </script>
</body>
</html>