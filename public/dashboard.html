<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAG v2 — Tableau de bord</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0a0a0a; color:#ffffff; display:flex; align-items:center; justify-content:center; min-height:100vh; margin:0; }
        .box { text-align:center; padding:2rem; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:12px; max-width:760px; width:90%; }
        h1 { margin:0 0 0.5rem; font-size:1.8rem; }
        p { color:#bbbbbb; margin:0.5rem 0 1rem; }
        a { color:#ff6666; text-decoration:none; }
        .links { margin-top:1rem; display:flex; gap:0.75rem; justify-content:center; flex-wrap:wrap; }
        .btn { padding:0.6rem 1rem; border-radius:8px; background:#1a1a1a; border:1px solid #333333; color:#ffffff; }
        .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:1rem; margin-top:1.25rem; text-align:left; }
        .card { background:#111111; border:1px solid #2a2a2a; border-radius:10px; padding:1rem; }
        .card h3 { margin:0 0 .5rem; font-size:1.1rem; }
        .kv { display:flex; justify-content:space-between; gap:1rem; padding:.25rem 0; color:#cccccc; }
        .muted { color:#9a9a9a; }
        .error { color:#ff7777; }
        code { background:#161616; border:1px solid #2a2a2a; padding:2px 6px; border-radius:6px; color:#ddd; }
        .uploader { display:flex; flex-direction:column; gap:.5rem; }
        .uploader input[type="file"] { display:block; }
        .row { display:flex; gap:.5rem; align-items:center; }
        .select { background:#1a1a1a; color:#fff; border:1px solid #333; border-radius:8px; padding:.5rem; }
        .btn-primary { padding:0.6rem 1rem; border-radius:8px; background:#e53e3e; border:1px solid #9b2c2c; color:#ffffff; cursor:pointer; }
        .preview { width:100%; max-height:160px; object-fit:cover; border-radius:8px; border:1px solid #333; background:#161616; }
    </style>
</head>
<body>
    <div class="box">
        <h1>Tableau de bord — BAG v2</h1>
        <p>Version minimale affichant l’état du service et les statistiques clés du serveur.</p>
        <div class="links">
            <a class="btn" href="/index.html">Accueil</a>
            <a class="btn" href="/health" target="_blank">Santé (JSON)</a>
            <a class="btn" href="/api/stats" target="_blank">Statistiques (JSON)</a>
        </div>

        <div class="grid">
            <div class="card">
                <h3>État du service</h3>
                <div id="health">
                    <div class="muted">Chargement...</div>
                </div>
            </div>
            <div class="card">
                <h3>Statistiques serveur</h3>
                <div id="stats">
                    <div class="muted">Chargement...</div>
                </div>
            </div>
            <div class="card">
                <h3>Fond de carte (upload)</h3>
                <div class="uploader">
                    <div class="row">
                        <label for="style">Style</label>
                        <select id="style" class="select">
                            <option value="holographic">holographic</option>
                            <option value="gamer">gamer</option>
                            <option value="amour">amour</option>
                            <option value="sensuel">sensuel</option>
                            <option value="futuristic">futuristic</option>
                            <option value="elegant">elegant</option>
                            <option value="gaming">gaming</option>
                            <option value="minimal">minimal</option>
                        </select>
                    </div>
                    <input id="file" type="file" accept="image/png,image/jpeg,image/webp" />
                    <img id="preview" class="preview" alt="Prévisualisation" />
                    <button id="uploadBtn" class="btn-primary">Téléverser</button>
                    <div id="uploadMsg" class="muted"></div>
                </div>
            </div>
        </div>

        <div class="muted" style="margin-top:1rem">Fonctions avancées du tableau de bord en cours d’ajout.</div>
    </div>

    <script>
        async function safeJson(url) {
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(String(res.status));
                return await res.json();
            } catch (e) {
                return { __error: e.message };
            }
        }

        function setKV(container, entries) {
            container.innerHTML = entries.map(([k,v]) => `\n                <div class=\"kv\">\n                    <span>${k}</span>\n                    <span>${v}</span>\n                </div>\n            `).join('');
        }

        (async function init() {
            const healthEl = document.getElementById('health');
            const statsEl = document.getElementById('stats');
            const params = new URLSearchParams(window.location.search);
            const guildId = params.get('guildId');

            const [health, stats] = await Promise.all([
                safeJson('/health'),
                safeJson(guildId ? `/api/stats?guildId=${encodeURIComponent(guildId)}` : '/api/stats')
            ]);

            if (health.__error) {
                healthEl.innerHTML = `<div class=\"error\">Erreur: ${health.__error}</div>`;
            } else {
                setKV(healthEl, [
                    ['Statut', health.status || '—'],
                    ['Discord', health.discord || '—'],
                    ['Uptime', (typeof health.uptime === 'number') ? `${Math.floor(health.uptime/3600)}h ${Math.floor((health.uptime%3600)/60)}m` : '—'],
                    ['Serveurs (guildes)', health.guilds ?? '—'],
                    ['Commandes chargées', health.commands ?? '—']
                ]);
            }

            const s = stats && stats.success === true && stats.data ? stats.data : stats;
            if (s.__error) {
                statsEl.innerHTML = `<div class=\"error\">Erreur: ${s.__error}</div>`;
            } else {
                setKV(statsEl, [
                    ['Membres actifs (24h)', s.activeMembers ?? 0],
                    ['Messages du jour', s.todayMessages ?? 0],
                    ['Commandes utilisées (jour)', s.commandsUsed ?? 0],
                    ['Argent total (€)', (typeof s.totalMoney === 'number') ? s.totalMoney.toLocaleString('fr-FR') : (s.totalMoney ?? 0)],
                    ['Utilisateurs total', s.totalUsers ?? 0],
                    ['Confessions total', s.totalConfessions ?? 0]
                ]);
            }

            // Uploader logic
            const fileInput = document.getElementById('file');
            const styleInput = document.getElementById('style');
            const preview = document.getElementById('preview');
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadMsg = document.getElementById('uploadMsg');

            fileInput.addEventListener('change', () => {
                const f = fileInput.files && fileInput.files[0];
                if (!f) { preview.src = ''; return; }
                const reader = new FileReader();
                reader.onload = e => { preview.src = e.target.result; };
                reader.readAsDataURL(f);
            });

            uploadBtn.addEventListener('click', async () => {
                uploadMsg.textContent = 'Téléversement en cours...';
                const f = fileInput.files && fileInput.files[0];
                if (!f) { uploadMsg.textContent = 'Veuillez choisir une image.'; return; }
                const fd = new FormData();
                fd.append('style', styleInput.value);
                fd.append('image', f);
                try {
                    const res = await fetch('/api/upload/style-background', { method: 'POST', body: fd });
                    const json = await res.json();
                    if (!json.success) throw new Error(json.error || 'Erreur inconnue');
                    uploadMsg.textContent = '✅ Image enregistrée. Style mis à jour.';
                } catch (e) {
                    uploadMsg.textContent = '❌ ' + e.message;
                }
            });
        })();
    </script>
</body>
</html>