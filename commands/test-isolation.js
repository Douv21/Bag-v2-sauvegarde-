const { SlashCommandBuilder, PermissionFlagsBits, EmbedBuilder } = require('discord.js');
const QuarantineChannelManager = require('../handlers/QuarantineChannelManager');

module.exports = {
  data: new SlashCommandBuilder()
    .setName('test-isolation')
    .setDescription('Tester l\'isolation compl√®te du syst√®me de quarantaine')
    .addSubcommand(subcommand =>
      subcommand
        .setName('membre')
        .setDescription('Tester l\'isolation d\'un membre sp√©cifique en quarantaine')
        .addUserOption(o => o.setName('membre').setDescription('Membre en quarantaine √† tester').setRequired(true)))
    .addSubcommand(subcommand =>
      subcommand
        .setName('systeme')
        .setDescription('Tester l\'ensemble du syst√®me de quarantaine'))
    .addSubcommand(subcommand =>
      subcommand
        .setName('permissions')
        .setDescription('Tester les permissions sur tous les canaux')
        .addRoleOption(o => o.setName('role').setDescription('R√¥le de quarantaine √† tester (optionnel)')))
    .setDefaultMemberPermissions(PermissionFlagsBits.Administrator.toString()),

  cooldown: 15,

  async execute(interaction) {
    if (!interaction.member.permissions.has(PermissionFlagsBits.Administrator)) {
      return interaction.reply({ content: '‚ùå R√©serv√© aux administrateurs.', ephemeral: true });
    }

    const mod = interaction.client.moderationManager;
    if (!mod) {
      return interaction.reply({ content: '‚ùå Syst√®me de mod√©ration non disponible.', ephemeral: true });
    }

    this.quarantineManager = new QuarantineChannelManager(mod);
    const subcommand = interaction.options.getSubcommand();

    try {
      switch (subcommand) {
        case 'membre':
          await this.testMemberIsolation(interaction);
          break;
        case 'systeme':
          await this.testSystemIntegrity(interaction);
          break;
        case 'permissions':
          await this.testPermissions(interaction);
          break;
      }
    } catch (error) {
      console.error('Erreur test isolation:', error);
      return interaction.reply({ content: '‚ùå Erreur lors du test d\'isolation.', ephemeral: true });
    }
  },

  async testMemberIsolation(interaction) {
    const member = interaction.options.getMember('membre');

    if (!member) {
      return interaction.reply({ content: '‚ùå Membre introuvable sur ce serveur.', ephemeral: true });
    }

    await interaction.deferReply({ ephemeral: true });

    try {
      // V√©rifier si le membre est en quarantaine
      const config = await this.quarantineManager.moderationManager.getSecurityConfig(interaction.guild.id);
      const quarantineRoleId = config.accessControl?.quarantineRoleId;

      if (!quarantineRoleId) {
        return interaction.editReply({
          content: '‚ùå **Syst√®me de quarantaine non configur√©**\n\nConfigurez d\'abord avec `/config-verif quarantaine`'
        });
      }

      const isQuarantined = member.roles.cache.has(quarantineRoleId);
      if (!isQuarantined) {
        return interaction.editReply({
          content: `‚ùå **${member.user.tag} n'est pas en quarantaine**\n\nCe test ne peut √™tre effectu√© que sur un membre actuellement en quarantaine.`
        });
      }

      console.log(`üß™ Test d'isolation pour ${member.user.tag}`);

      // Effectuer le test complet
      const report = await this.quarantineManager.verifyAndFixQuarantineIsolation(member);

      // Analyser les r√©sultats
      const isolationScore = report.restrictedChannels / (report.restrictedChannels + report.accessibleChannels) * 100;
      const isolationStatus = isolationScore === 100 ? '‚úÖ Parfaite' : 
                             isolationScore >= 90 ? '‚ö†Ô∏è Bonne' : 
                             isolationScore >= 70 ? '‚ö†Ô∏è Partielle' : '‚ùå Insuffisante';

      const embed = new EmbedBuilder()
        .setTitle('üß™ Test d\'isolation - R√©sultats d√©taill√©s')
        .setDescription(`Test d'isolation pour **${member.user.tag}**`)
        .setColor(isolationScore === 100 ? 0x51cf66 : isolationScore >= 70 ? 0xff922b : 0xff6b6b)
        .addFields(
          {
            name: 'üìä Score d\'isolation',
            value: `**${isolationScore.toFixed(1)}%** - ${isolationStatus}`,
            inline: true
          },
          {
            name: 'üîí Canaux restreints',
            value: `${report.restrictedChannels}`,
            inline: true
          },
          {
            name: '‚ö†Ô∏è Canaux accessibles',
            value: `${report.accessibleChannels}`,
            inline: true
          },
          {
            name: 'üîß Configuration effectu√©e',
            value: `**Configur√©s :** ${report.stats.configured}\n` +
                   `**Ignor√©s :** ${report.stats.skipped}\n` +
                   `**Erreurs :** ${report.stats.errors}`,
            inline: false
          }
        )
        .setTimestamp();

      // D√©tails des canaux accessibles si il y en a
      if (report.accessibleChannels > 0) {
        let accessDetails = '';
        for (const channel of report.accessibleChannelsList) {
          accessDetails += `‚Ä¢ **${channel.name}** (Type: ${channel.type})\n`;
        }
        if (report.accessibleChannels > report.accessibleChannelsList.length) {
          accessDetails += `‚Ä¢ Et ${report.accessibleChannels - report.accessibleChannelsList.length} autres...\n`;
        }

        embed.addFields({
          name: '‚ö†Ô∏è Canaux encore accessibles',
          value: accessDetails || 'Aucun d√©tail disponible',
          inline: false
        });
      }

      // Recommandations
      let recommendations = [];
      if (isolationScore < 100) {
        recommendations.push('‚Ä¢ V√©rifiez les permissions sp√©ciales sur les canaux accessibles');
        recommendations.push('‚Ä¢ Relancez `/quarantaine configurer-permissions`');
        recommendations.push('‚Ä¢ V√©rifiez si le membre a d\'autres r√¥les avec permissions');
      }
      if (report.stats.errors > 0) {
        recommendations.push('‚Ä¢ Consultez les logs pour les erreurs de permissions');
        recommendations.push('‚Ä¢ V√©rifiez les permissions du bot sur les canaux en erreur');
      }
      if (recommendations.length === 0) {
        recommendations.push('‚úÖ L\'isolation est parfaite, aucune action requise');
      }

      embed.addFields({
        name: 'üí° Recommandations',
        value: recommendations.join('\n'),
        inline: false
      });

      return interaction.editReply({ embeds: [embed] });

    } catch (error) {
      console.error('Erreur test isolation membre:', error);
      return interaction.editReply({
        content: `‚ùå **Erreur lors du test**\n\n${error.message}`
      });
    }
  },

  async testSystemIntegrity(interaction) {
    await interaction.deferReply({ ephemeral: true });

    try {
      const config = await this.quarantineManager.moderationManager.getSecurityConfig(interaction.guild.id);
      const guild = interaction.guild;

      console.log('üß™ Test d\'int√©grit√© du syst√®me de quarantaine');

      // Tests de base
      const tests = {
        systemEnabled: config.enabled,
        quarantineRoleConfigured: !!config.accessControl?.quarantineRoleId,
        quarantineRoleExists: false,
        verifiedRoleConfigured: !!config.accessControl?.verifiedRoleId,
        alertChannelConfigured: !!config.autoAlerts?.alertChannelId,
        moderatorRoleConfigured: !!config.autoAlerts?.moderatorRoleId,
        autoVerificationEnabled: config.autoVerification?.enabled,
        quarantineCategory: false,
        activeQuarantines: 0,
        orphanedChannels: 0,
        permissionsCoverage: 0
      };

      // V√©rifier l'existence du r√¥le
      if (tests.quarantineRoleConfigured) {
        const quarantineRole = guild.roles.cache.get(config.accessControl.quarantineRoleId);
        tests.quarantineRoleExists = !!quarantineRole;

        if (quarantineRole) {
          // Tester les permissions sur un √©chantillon de canaux
          const testChannels = guild.channels.cache
            .filter(c => [0, 2].includes(c.type) && !c.name.toLowerCase().includes('quarantaine'))
            .first(20);

          let configuredCount = 0;
          for (const channel of testChannels.values()) {
            try {
              const overwrite = channel.permissionOverwrites.cache.get(quarantineRole.id);
              if (overwrite && overwrite.deny.has(PermissionFlagsBits.ViewChannel)) {
                configuredCount++;
              }
            } catch {}
          }
          tests.permissionsCoverage = testChannels.size > 0 ? (configuredCount / testChannels.size) * 100 : 0;
        }
      }

      // V√©rifier la cat√©gorie de quarantaine
      const quarantineCategory = guild.channels.cache.find(
        c => c.type === 4 && c.name.toLowerCase().includes('quarantaine')
      );
      tests.quarantineCategory = !!quarantineCategory;

      // Compter les quarantaines actives
      const quarantinedMembers = await this.quarantineManager.listQuarantinedMembers(guild);
      tests.activeQuarantines = quarantinedMembers.length;

      // Compter les canaux orphelins
      if (quarantineCategory) {
        const quarantineChannels = quarantineCategory.children.cache.size;
        tests.orphanedChannels = Math.max(0, quarantineChannels - tests.activeQuarantines * 2);
      }

      // Calculer le score global
      const criticalTests = [
        tests.systemEnabled,
        tests.quarantineRoleConfigured,
        tests.quarantineRoleExists
      ];
      const optionalTests = [
        tests.verifiedRoleConfigured,
        tests.alertChannelConfigured,
        tests.moderatorRoleConfigured,
        tests.autoVerificationEnabled,
        tests.quarantineCategory,
        tests.permissionsCoverage >= 90
      ];

      const criticalScore = criticalTests.filter(Boolean).length / criticalTests.length * 100;
      const optionalScore = optionalTests.filter(Boolean).length / optionalTests.length * 100;
      const globalScore = (criticalScore * 0.7 + optionalScore * 0.3);

      const embed = new EmbedBuilder()
        .setTitle('üß™ Test d\'int√©grit√© du syst√®me')
        .setDescription(`Analyse compl√®te du syst√®me de quarantaine`)
        .setColor(globalScore >= 90 ? 0x51cf66 : globalScore >= 70 ? 0xff922b : 0xff6b6b)
        .addFields(
          {
            name: 'üìä Score global',
            value: `**${globalScore.toFixed(1)}%** - ${globalScore >= 90 ? '‚úÖ Excellent' : globalScore >= 70 ? '‚ö†Ô∏è Bon' : '‚ùå Insuffisant'}`,
            inline: true
          },
          {
            name: 'üîß Tests critiques',
            value: `**${criticalScore.toFixed(0)}%** (${criticalTests.filter(Boolean).length}/${criticalTests.length})`,
            inline: true
          },
          {
            name: '‚≠ê Tests optionnels',
            value: `**${optionalScore.toFixed(0)}%** (${optionalTests.filter(Boolean).length}/${optionalTests.length})`,
            inline: true
          }
        );

      // D√©tails des tests
      embed.addFields({
        name: 'üîç Tests critiques',
        value: `${tests.systemEnabled ? '‚úÖ' : '‚ùå'} Syst√®me activ√©\n` +
               `${tests.quarantineRoleConfigured ? '‚úÖ' : '‚ùå'} R√¥le de quarantaine configur√©\n` +
               `${tests.quarantineRoleExists ? '‚úÖ' : '‚ùå'} R√¥le de quarantaine existant`,
        inline: true
      });

      embed.addFields({
        name: '‚öôÔ∏è Configuration optionnelle',
        value: `${tests.verifiedRoleConfigured ? '‚úÖ' : '‚ùå'} R√¥le v√©rifi√©\n` +
               `${tests.alertChannelConfigured ? '‚úÖ' : '‚ùå'} Canal d'alertes\n` +
               `${tests.moderatorRoleConfigured ? '‚úÖ' : '‚ùå'} R√¥le mod√©rateur\n` +
               `${tests.autoVerificationEnabled ? '‚úÖ' : '‚ùå'} V√©rification auto`,
        inline: true
      });

      embed.addFields({
        name: 'üìä √âtat actuel',
        value: `**Quarantaines actives :** ${tests.activeQuarantines}\n` +
               `**Cat√©gorie pr√©sente :** ${tests.quarantineCategory ? '‚úÖ' : '‚ùå'}\n` +
               `**Canaux orphelins :** ${tests.orphanedChannels}\n` +
               `**Couverture permissions :** ${tests.permissionsCoverage.toFixed(1)}%`,
        inline: false
      });

      // Recommandations
      let recommendations = [];
      if (!tests.systemEnabled) recommendations.push('‚Ä¢ Activez le syst√®me avec `/config-verif activer`');
      if (!tests.quarantineRoleConfigured) recommendations.push('‚Ä¢ Configurez le r√¥le avec `/config-verif quarantaine`');
      if (!tests.quarantineRoleExists) recommendations.push('‚Ä¢ Recr√©ez le r√¥le de quarantaine');
      if (tests.permissionsCoverage < 90) recommendations.push('‚Ä¢ Reconfigurez les permissions avec `/quarantaine configurer-permissions`');
      if (tests.orphanedChannels > 0) recommendations.push('‚Ä¢ Nettoyez les canaux orphelins avec `/quarantaine nettoyer`');
      if (!tests.alertChannelConfigured) recommendations.push('‚Ä¢ Configurez les alertes avec `/config-verif admins`');

      if (recommendations.length === 0) {
        recommendations.push('‚úÖ Le syst√®me est optimal, aucune action requise');
      }

      embed.addFields({
        name: 'üí° Recommandations',
        value: recommendations.slice(0, 8).join('\n'),
        inline: false
      });

      embed.setTimestamp();

      return interaction.editReply({ embeds: [embed] });

    } catch (error) {
      console.error('Erreur test syst√®me:', error);
      return interaction.editReply({
        content: `‚ùå **Erreur lors du test syst√®me**\n\n${error.message}`
      });
    }
  },

  async testPermissions(interaction) {
    const testRole = interaction.options.getRole('role');
    
    await interaction.deferReply({ ephemeral: true });

    try {
      const config = await this.quarantineManager.moderationManager.getSecurityConfig(interaction.guild.id);
      const guild = interaction.guild;

      // D√©terminer le r√¥le √† tester
      let quarantineRole = testRole;
      if (!quarantineRole && config.accessControl?.quarantineRoleId) {
        quarantineRole = guild.roles.cache.get(config.accessControl.quarantineRoleId);
      }

      if (!quarantineRole) {
        return interaction.editReply({
          content: '‚ùå **Aucun r√¥le de quarantaine √† tester**\n\nSp√©cifiez un r√¥le ou configurez le syst√®me avec `/config-verif quarantaine`'
        });
      }

      console.log(`üß™ Test des permissions pour le r√¥le ${quarantineRole.name}`);

      // Analyser tous les canaux
      const allChannels = guild.channels.cache.filter(channel => {
        return [0, 2, 4, 5, 13, 15].includes(channel.type) && // Types de canaux support√©s
               !channel.name.toLowerCase().includes('quarantaine'); // Exclure quarantaine
      });

      const results = {
        total: allChannels.size,
        configured: 0,
        missing: 0,
        errors: 0,
        details: []
      };

      for (const channel of allChannels.values()) {
        try {
          const overwrite = channel.permissionOverwrites.cache.get(quarantineRole.id);
          const hasRestriction = overwrite && overwrite.deny.has(PermissionFlagsBits.ViewChannel);
          
          if (hasRestriction) {
            results.configured++;
          } else {
            results.missing++;
            results.details.push({
              name: channel.name,
              type: channel.type,
              parent: channel.parent?.name || 'Aucune cat√©gorie',
              reason: !overwrite ? 'Aucune permission configur√©e' : 'Permission ViewChannel non refus√©e'
            });
          }
        } catch (error) {
          results.errors++;
          results.details.push({
            name: channel.name,
            type: channel.type,
            parent: channel.parent?.name || 'Aucune cat√©gorie',
            reason: `Erreur: ${error.message}`
          });
        }
      }

      const coveragePercent = results.total > 0 ? (results.configured / results.total) * 100 : 0;

      const embed = new EmbedBuilder()
        .setTitle('üß™ Test des permissions - Analyse d√©taill√©e')
        .setDescription(`Test des permissions pour le r√¥le **${quarantineRole.name}**`)
        .setColor(coveragePercent === 100 ? 0x51cf66 : coveragePercent >= 90 ? 0xff922b : 0xff6b6b)
        .addFields(
          {
            name: 'üìä R√©sum√©',
            value: `**Couverture :** ${coveragePercent.toFixed(1)}%\n` +
                   `**Canaux test√©s :** ${results.total}\n` +
                   `**Correctement configur√©s :** ${results.configured}\n` +
                   `**Non configur√©s :** ${results.missing}\n` +
                   `**Erreurs :** ${results.errors}`,
            inline: false
          }
        );

      // D√©tails des probl√®mes
      if (results.missing > 0 || results.errors > 0) {
        let problemDetails = '';
        const problemChannels = results.details.slice(0, 10);
        
        for (const detail of problemChannels) {
          problemDetails += `‚Ä¢ **${detail.name}** (${detail.parent})\n  ${detail.reason}\n`;
        }
        
        if (results.details.length > 10) {
          problemDetails += `\n*Et ${results.details.length - 10} autres probl√®mes...*`;
        }

        embed.addFields({
          name: '‚ö†Ô∏è Canaux probl√©matiques',
          value: problemDetails || 'Aucun d√©tail disponible',
          inline: false
        });
      }

      // Actions recommand√©es
      let actions = [];
      if (results.missing > 0) {
        actions.push('‚Ä¢ Ex√©cutez `/quarantaine configurer-permissions` pour corriger');
      }
      if (results.errors > 0) {
        actions.push('‚Ä¢ V√©rifiez les permissions du bot sur les canaux en erreur');
      }
      if (coveragePercent < 100) {
        actions.push('‚Ä¢ V√©rifiez manuellement les canaux non configur√©s');
      }
      if (actions.length === 0) {
        actions.push('‚úÖ Toutes les permissions sont correctement configur√©es');
      }

      embed.addFields({
        name: 'üí° Actions recommand√©es',
        value: actions.join('\n'),
        inline: false
      });

      embed.setTimestamp();

      return interaction.editReply({ embeds: [embed] });

    } catch (error) {
      console.error('Erreur test permissions:', error);
      return interaction.editReply({
        content: `‚ùå **Erreur lors du test des permissions**\n\n${error.message}`
      });
    }
  }
};